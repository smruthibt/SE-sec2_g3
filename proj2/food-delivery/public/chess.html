<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>BiteCode • Chess Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Simple styling -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">



  <!-- Chessboard.js styles -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css"
/>

<!-- Chess engine (chess.js) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>

<!-- Chessboard.js -->

<link rel="stylesheet"
      href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
      integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"
      crossorigin="anonymous">
      <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
        crossorigin="anonymous"></script>

<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
        integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
        crossorigin="anonymous"></script>

  
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #f5f5f5;
    }
    #board {
      max-width: 400px;
      margin: 0 auto;
    }
  </style>
</head>

<body class="py-4">
  <div class="container">
    <div class="mb-3">
      <a href="/orders.html" class="btn btn-link">&larr; Back to orders</a>
    </div>

    <div class="text-center mb-4">
      <h3>♟️ BiteCode Chess Challenge</h3>
      <p class="text-muted mb-1">Solve the puzzle in under <strong>60 seconds</strong> with no wrong moves to earn a discount.</p>
      <p class="small text-muted" id="orderInfo"></p>
    </div>

    <div class="row justify-content-center">
      <div class="col-md-5 text-center">
        <div class="mb-3">
          <label for="difficulty" class="form-label">Select difficulty</label>
          <select id="difficulty" class="form-select form-select-sm" style="max-width: 200px; margin: 0 auto;">
            <option value="easy">Easy (small discount)</option>
            <option value="medium" selected>Medium (better discount)</option>
            <option value="hard">Hard (highest discount)</option>
          </select>
        </div>

        <div id="board" class="mb-3"></div>

        <p class="h5 mb-1">Time left: <span id="timer">60</span> s</p>
        <p class="small text-muted mb-2" id="instruction">Your move: find the best move for the side to move.</p>

        <div class="d-flex justify-content-center gap-2">
          <button id="startBtn" class="btn btn-primary btn-sm">Start puzzle</button>
          <button id="giveUpBtn" class="btn btn-outline-secondary btn-sm" disabled>Give up</button>
        </div>

        <div class="mt-3" id="status" class="fw-semibold"></div>
      </div>
    </div>
  </div>

  <script>
    console.log("Chess global:", typeof Chess);
console.log("Chessboard global:", typeof Chessboard);

    const API_BASE = (window.API_BASE || (location.origin + "/api"));

    // --- Parse query params (orderId, difficulty from parent) ---
    const urlParams = new URLSearchParams(window.location.search);
    const orderIdFromQuery = urlParams.get("orderId");
    const initialDifficulty = urlParams.get("difficulty") || "medium";

    const difficultySelect = document.getElementById("difficulty");
    difficultySelect.value = initialDifficulty;

    const orderInfoEl = document.getElementById("orderInfo");
    if (orderIdFromQuery) {
      orderInfoEl.textContent = "For order ID: " + orderIdFromQuery;
    }

    const timerEl = document.getElementById("timer");
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const giveUpBtn = document.getElementById("giveUpBtn");
    const instructionEl = document.getElementById("instruction");

    // --- Simple puzzle bank (one puzzle per difficulty for now) ---
    // FEN positions + correct move in UCI
    const PUZZLES = {
      easy: {
        fen: "8/8/8/8/8/5k2/6Q1/7K w - - 0 1",
        solution: "g2g4", // Qg4+
        side: "w"
      },
      medium: {
        fen: "r1bqkbnr/pppp1ppp/2n5/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 2 3",
        solution: "f1b5", // Bb5
        side: "w"
      },
      hard: {
        fen: "r3k2r/pp1n1ppp/2p1pn2/q2p4/3P4/2N1PN2/PP3PPP/R2Q1RK1 w kq - 0 1",
        solution: "a1b1", // Artificial example – replace with nicer one later
        side: "w"
      }
    };

    let game = null;
    let board = null;
    let timerId = null;
    let timeLeft = 60;
    let wrongMove = false;
    let puzzleSolution = null;

    function resetTimer() {
      clearInterval(timerId);
      timeLeft = 60;
      timerEl.textContent = timeLeft;
    }

    function startTimer() {
      resetTimer();
      timerId = setInterval(() => {
        timeLeft -= 1;
        timerEl.textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timerId);
          timerId = null;
          statusEl.textContent = "⏰ Time's up! No discount this time.";
          finalizeChallenge(false);
        }
      }, 1000);
    }

    function onDragStart (source, piece, position, orientation) {
      if (!game || !game.game_over()) {
        // Only allow side to move to drag
        const turn = game.turn();
        if ((turn === "w" && piece.startsWith("b")) || (turn === "b" && piece.startsWith("w"))) {
          return false;
        }
      }
    }

    async function onDrop (source, target) {
      if (!game) return "snapback";

      const move = game.move({
        from: source,
        to: target,
        promotion: "q"
      });

      if (move === null) return "snapback";

      // Compare move with puzzle solution (UCI)
      const uciPlayed = source + target;
      if (uciPlayed === puzzleSolution) {
        // Correct solution
        clearInterval(timerId);
        timerId = null;
        statusEl.textContent = "✅ Correct! Applying your chess discount…";
        board.position(game.fen());
        await finalizeChallenge(true);
      } else {
        wrongMove = true;
        clearInterval(timerId);
        timerId = null;
        statusEl.textContent = "❌ Wrong move – challenge failed.";
        await finalizeChallenge(false);
      }
    }

    function initBoard(fen, sideToMove) {
      game = new Chess(fen);
      board = Chessboard("board", {
        position: fen,
        draggable: true,
        orientation: sideToMove === "w" ? "white" : "black",
        pieceTheme: "https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",

        onDragStart,
        onDrop
      });
    }

    startBtn.addEventListener("click", () => {
      const difficulty = difficultySelect.value;
      const puzzle = PUZZLES[difficulty];

      if (!puzzle) {
        alert("No puzzle defined for difficulty " + difficulty);
        return;
      }

      puzzleSolution = puzzle.solution;
      wrongMove = false;
      statusEl.textContent = "";
      instructionEl.textContent = `Difficulty: ${difficulty}. Solve in under 60s with no wrong moves.`;

      initBoard(puzzle.fen, puzzle.side);
      startTimer();

      startBtn.disabled = true;
      difficultySelect.disabled = true;
      giveUpBtn.disabled = false;
    });

    giveUpBtn.addEventListener("click", async () => {
      clearInterval(timerId);
      timerId = null;
      statusEl.textContent = "You gave up. No discount this time.";
      await finalizeChallenge(false);
    });

    async function finalizeChallenge(success) {
      startBtn.disabled = true;
      giveUpBtn.disabled = true;

      try {
        const difficulty = difficultySelect.value;
        const res = await fetch(`${API_BASE}/chess-challenge/complete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            orderId: orderIdFromQuery,
            difficulty,
            success: !!success
          })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          statusEl.textContent += "  " + (data.error || "Server error.");
          return;
        }

        if (success) {
          statusEl.textContent += data.coupon
            ? `  Coupon earned: ${data.coupon.code} (${data.coupon.label}).`
            : "  Coupon earned!";
        } else {
          statusEl.textContent += "  Better luck next time!";
        }

        // Give user a moment, then close the window so parent can refresh
        setTimeout(() => {
          window.close();
        }, 2000);
      } catch (err) {
        console.error(err);
        statusEl.textContent += "  Could not contact server.";
      }
    }
  </script>
</body>
</html>
