<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>bitecode — Supermarket</title>

  <!-- CSS/Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent: #16a34a;
      --text: #0e0e0e;
      --muted: #6a6f73;
      --card: #fff;
      --radius: 16px;
    }

    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background-color: #f6f7f8;
    }

    .navbar {
      background: #fff !important;
      border-bottom: 1px solid rgba(0, 0, 0, .06);
    }

    .brand-logo {
      height: 80px;
      width: auto;
      display: inline-block;
      vertical-align: middle;
    }

    .auth-fixed {
      position: fixed;
      top: 8px;
      right: 12px;
      z-index: 1100;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    #authChip {
      font-size: .8rem;
      border: 1px solid transparent;
    }

    .chip-out {
      background: #f3f4f6;
      color: #111827;
      border-color: #e5e7eb;
    }

    .chip-in {
      background: #e6f4ea;
      color: #166534;
      border-color: #cce3d2;
    }

    .badge-cart {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #dc3545;
    }

    .hero-cover {
      position: relative;
      max-height: 260px;
      overflow: hidden;
      border-bottom-left-radius: 24px;
      border-bottom-right-radius: 24px;
    }

    .hero-cover img {
      width: 100%;
      height: 260px;
      object-fit: cover;
    }

    .hero-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.2), transparent);
    }

    .hero-content {
      position: absolute;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      width: min(960px, 100% - 32px);
      color: #fff;
    }

    .hero-title {
      font-weight: 800;
      font-size: 1.75rem;
    }

    .hero-meta {
      font-size: .9rem;
      opacity: .95;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      padding: .15rem .6rem;
      border-radius: 999px;
      font-size: .8rem;
      background: rgba(17, 24, 39, 0.85);
      color: #f9fafb;
    }

    .section-title {
      font-weight: 800;
    }

    .item-card {
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #fff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
      transition: box-shadow .18s ease, transform .16s ease;
    }

    .item-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.08);
    }

    .item-thumb {
      width: 100%;
      height: 140px;
      object-fit: cover;
    }

    .item-body {
      padding: .75rem .9rem .85rem;
      display: flex;
      flex-direction: column;
      gap: .25rem;
      flex: 1;
    }

    .item-name {
      font-weight: 600;
      font-size: .98rem;
    }

    .item-meta {
      font-size: .8rem;
      color: var(--muted);
    }

    .item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: .35rem;
      font-size: .9rem;
    }

    footer {
      background: #ffffff;
      border-top: 1px solid rgba(0, 0, 0, .06);
    }

    footer .link-muted {
      color: var(--muted);
      text-decoration: none;
    }

    footer .link-muted:hover {
      text-decoration: underline;
      color: #0e0e0e;
    }

    footer .brand-logo {
      height: 50px;
    }
  </style>

  <script>
    // If your API runs on another port, you can override:
    // window.API_BASE = "http://localhost:3001/api";
  </script>
</head>

<body>
  <!-- NAV -->
  <nav class="navbar sticky-top">
    <div class="container py-2">
      <a class="navbar-brand d-inline-flex align-items-center gap-2" href="/index.html">
        <img src="/assets/BiteCodeNOBG.png" alt="BiteCode logo" class="brand-logo">
      </a>
      <div class="d-flex align-items-center gap-2 ms-auto">
        <a class="btn btn-outline-secondary rounded-pill" href="/orders.html">My Orders</a>
        <a class="position-relative btn btn-outline-primary rounded-pill" href="/cart.html" id="cartLink">
          <span class="me-1">Cart</span>
          <span class="position-absolute translate-middle badge rounded-pill badge-cart" id="cartCount"
            style="display:none;">0</span>
        </a>
      </div>
    </div>
  </nav>

  <div class="auth-fixed">
    <span id="authChip" class="badge rounded-pill px-2 py-1 fw-semibold d-none">Status</span>
    <button id="authBtn" class="btn btn-outline-secondary btn-sm rounded-pill">Sign in</button>
  </div>

  <!-- HERO -->
  <header class="hero-cover mb-4">
    <img id="heroImage" src="/assets/placeholder-restaurant.jpg" alt="Supermarket cover"
      onerror="this.onerror=null; this.src='/assets/placeholder-restaurant.jpg';">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <div class="d-flex justify-content-between flex-wrap gap-2">
        <div>
          <div id="marketName" class="hero-title mb-1">Loading…</div>
          <div id="marketMeta" class="hero-meta">
            <!-- rating • fee • eta -->
          </div>
          <div id="marketAddress" class="hero-meta mt-1">
            <!-- address -->
          </div>
        </div>
        <div class="d-flex flex-column align-items-end gap-2">
          <div id="marketTags" class="text-end small">
            <!-- tags as chips -->
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container pb-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="section-title h5 mb-0">Groceries</h2>
      <span id="itemsCount" class="text-muted small"></span>
    </div>

    <div id="itemsGrid" class="row g-3">
      <!-- items go here -->
    </div>

    <div id="emptyState" class="text-center text-muted py-5 d-none">
      No items available right now. Check back soon!
    </div>
  </main>

  <!-- JS -->
  <script>
    const API_BASE = (window.API_BASE || (location.origin + "/api"));

    const cartCountEl = document.getElementById("cartCount");
    const authChip = document.getElementById("authChip");
    const authBtn = document.getElementById("authBtn");

    const heroImage = document.getElementById("heroImage");
    const marketNameEl = document.getElementById("marketName");
    const marketMetaEl = document.getElementById("marketMeta");
    const marketAddressEl = document.getElementById("marketAddress");
    const marketTagsEl = document.getElementById("marketTags");

    const itemsGrid = document.getElementById("itemsGrid");
    const emptyState = document.getElementById("emptyState");
    const itemsCountEl = document.getElementById("itemsCount");
    let currentMarket = null;

    function getQueryId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    function setCartBadge(n) {
      if (n > 0) {
        cartCountEl.textContent = n;
        cartCountEl.style.display = "inline-block";
      } else {
        cartCountEl.style.display = "none";
      }
    }

async function updateCartCount() {
  try {
    const res = await fetch(`${API_BASE}/cart`, { credentials: "include" });
    if (res.ok) {
      const data = await res.json();

      // ✅ Always sum quantities
      let count = 0;

      if (Array.isArray(data)) {
        count = data.reduce((sum, item) => {
          const q = Number(item.quantity || 0);
          return sum + (isNaN(q) ? 0 : q);
        }, 0);
      } else if (Array.isArray(data?.items)) {
        count = data.items.reduce((sum, item) => {
          const q = Number(item.quantity || 0);
          return sum + (isNaN(q) ? 0 : q);
        }, 0);
      }

      setCartBadge(count);
      return;
    }
  } catch (e) {
    console.error("Error updating cart count:", e);
  }

  // Fallback to localStorage if API fails (optional)
  try {
    const local = JSON.parse(localStorage.getItem("cart") || "[]");
    const count = Array.isArray(local)
      ? local.reduce((sum, item) => sum + (Number(item.quantity || 0) || 0), 0)
      : 0;
    setCartBadge(count);
  } catch (e) {
    setCartBadge(0);
  }
}

    const LOGOUT_ENDPOINTS = [
      `${API_BASE}/auth/logout`,
      `${API_BASE}/logout`,
      `${API_BASE}/customers/logout`,
    ];

    async function tryLogout() {
      for (const url of LOGOUT_ENDPOINTS) {
        try {
          const r = await fetch(url, { method: "POST", credentials: "include" });
          if (r.ok || r.status === 204) return true;
        } catch {}
      }
      for (const url of LOGOUT_ENDPOINTS) {
        try {
          const r = await fetch(url, { method: "GET", credentials: "include" });
          if (r.ok || r.status === 204) return true;
        } catch {}
      }
      return false;
    }

    function setAuthUI(state) {
      authChip.classList.remove("d-none", "chip-in", "chip-out");
      if (state === "in") {
        authChip.textContent = "Signed in";
        authChip.classList.add("chip-in");
        authBtn.textContent = "Sign out";
        authBtn.className = "btn btn-outline-dark btn-sm rounded-pill";
        authBtn.onclick = async () => {
          await tryLogout();
          window.location.href = "/customer-login.html";
        };
      } else {
        authChip.textContent = "Not logged in";
        authChip.classList.add("chip-out");
        authBtn.textContent = "Sign in";
        authBtn.className = "btn btn-outline-secondary btn-sm rounded-pill";
        authBtn.onclick = () => (window.location.href = "/customer-login.html");
      }
    }

    async function checkAuth() {
      try {
        const res = await fetch(`${API_BASE}/cart`, { credentials: "include" });
        setAuthUI(res.status === 401 ? "out" : "in");
      } catch {
        setAuthUI("out");
      }
    }

    function renderMarket(market) {
      // Normalise id so _id is always present on currentMarket
      const normalizedId = market._id || market.id || market.supermarketId || null;
      currentMarket = { ...market, _id: normalizedId };

      marketNameEl.textContent = market.name || "Supermarket";
      heroImage.src = market.imageUrl || "/assets/placeholder-restaurant.jpg";

      const rating = typeof market.rating === "number"
        ? market.rating.toFixed(1)
        : (market.rating || "4.5");

      const fee = typeof market.deliveryFee === "number"
        ? market.deliveryFee.toFixed(2)
        : "0.00";

      const eta = market.etaMins || 25;

      marketMetaEl.innerHTML = `
        <span class="chip me-1"><i class="bi bi-star-fill"></i> ${rating}</span>
        <span class="chip me-1">$${fee} delivery</span>
        <span class="chip"><i class="bi bi-clock"></i> ${eta} min</span>
      `;

      marketAddressEl.textContent = market.address || "";

      marketTagsEl.innerHTML = "";
      if (Array.isArray(market.tags) && market.tags.length) {
        market.tags.forEach((tag) => {
          const chip = document.createElement("span");
          chip.className = "chip ms-1";
          chip.textContent = tag;
          marketTagsEl.appendChild(chip);
        });
      }
    }

    function renderItems(items) {
      itemsGrid.innerHTML = "";
      if (!Array.isArray(items) || items.length === 0) {
        emptyState.classList.remove("d-none");
        itemsCountEl.textContent = "";
        return;
      }

      emptyState.classList.add("d-none");
      itemsCountEl.textContent = `${items.length} item${items.length > 1 ? "s" : ""}`;

      for (const it of items) {
        const col = document.createElement("div");
        col.className = "col-12 col-sm-6 col-lg-4";

        const img = it.imageUrl || "/assets/placeholder-restaurant.jpg";
        const price = typeof it.price === "number"
          ? it.price.toFixed(2)
          : "0.00";

        const unit = it.unit || "unit";
        const category = it.category || "Groceries";

        col.innerHTML = `
          <div class="item-card">
            <img
              src="${img}"
              alt="${it.name}"
              class="item-thumb"
              loading="lazy"
              onerror="this.onerror=null; this.src='/assets/placeholder-restaurant.jpg';"
            />
            <div class="item-body">
              <div class="item-name">${it.name}</div>
              <div class="item-meta">
                ${category} • ${unit}
              </div>
              <div class="item-footer">
                <div class="fw-semibold">$${price}</div>
                <button
                  class="btn btn-sm btn-outline-success"
                  type="button"
                  data-add-supermarket="${it._id}">
                  Add
                </button>
              </div>
            </div>
          </div>
        `;
        itemsGrid.appendChild(col);
      }

      // Attach click handler to "Add" buttons
      itemsGrid.querySelectorAll("[data-add-supermarket]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const itemId = btn.getAttribute("data-add-supermarket");
          await addToCartSupermarket(itemId, 1);
        });
      });
    }

    async function loadMarketAndItems() {
      const id = getQueryId();
      if (!id) {
        marketNameEl.textContent = "Supermarket not found";
        marketMetaEl.textContent = "";
        marketAddressEl.textContent = "";
        emptyState.classList.remove("d-none");
        emptyState.textContent = "Missing supermarket id in URL.";
        return;
      }

      try {
        const [marketRes, itemsRes] = await Promise.all([
          fetch(`${API_BASE}/supermarkets/${encodeURIComponent(id)}`),
          fetch(`${API_BASE}/supermarket-menu?supermarketId=${encodeURIComponent(id)}`)
        ]);

        if (!marketRes.ok) {
          marketNameEl.textContent = "Supermarket not found";
          emptyState.classList.remove("d-none");
          emptyState.textContent = "This supermarket does not exist.";
          return;
        }

        const market = await marketRes.json();
        renderMarket(market);

        if (itemsRes.ok) {
          const items = await itemsRes.json();
          renderItems(items);
        } else {
          renderItems([]);
        }
      } catch (err) {
        console.error("Error loading supermarket page:", err);
        emptyState.classList.remove("d-none");
        emptyState.textContent = "Something went wrong. Please try again.";
      }
    }

    async function addToCartSupermarket(supermarketItemId, quantity) {
      // normalise the id again here, just in case
      const supermarketId =
        (currentMarket && (currentMarket._id || currentMarket.id || currentMarket.supermarketId)) || null;

      if (!supermarketId) {
        console.warn("No current supermarket set");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/cart`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            sourceType: "supermarket",
            supermarketItemId,
            supermarketId,
            quantity,
          }),
        });

        if (res.status === 401) {
          window.location.href = "/customer-login.html";
          return;
        }

        if (!res.ok) {
          console.error("Failed to add supermarket item:", await res.text());
          return;
        }

        // Update the cart badge
        updateCartCount();
      } catch (err) {
        console.error("Error adding supermarket item to cart:", err);
      }
    }

    (async function init() {
      await loadMarketAndItems();
      await updateCartCount();
      await checkAuth();
    })();
  </script>

</body>

</html>
